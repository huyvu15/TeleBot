<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.123.3">
    <meta name="description" content="">
<meta name="author" content="huyv80313@gmail.com">

    <link rel="icon" href="../../../images/favicon.png" type="image/png">

    <title>Thêm code vào lambda function :: Nhận thông báo chi tiêu cho hoạt động mua sắp tại Shopee</title>

    
    <link href="../../../css/nucleus.css?1720599204" rel="stylesheet">
    <link href="../../../css/fontawesome-all.min.css?1720599204" rel="stylesheet">
    <link href="../../../css/hybrid.css?1720599204" rel="stylesheet">
    <link href="../../../css/featherlight.min.css?1720599204" rel="stylesheet">
    <link href="../../../css/perfect-scrollbar.min.css?1720599204" rel="stylesheet">
    <link href="../../../css/auto-complete.css?1720599204" rel="stylesheet">
    <link href="../../../css/atom-one-dark-reasonable.css?1720599204" rel="stylesheet">
    <link href="../../../css/theme.css?1720599204" rel="stylesheet">
    <link href="../../../css/hugo-theme.css?1720599204" rel="stylesheet">
    
    <link href="../../../css/theme-workshop.css?1720599204" rel="stylesheet">
    
    

    <script src="../../../js/jquery-3.3.1.min.js?1720599204"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="../../../vi/4-/4.3-natgateway/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="../../../">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../../js/lunr.min.js?1720599204"></script>
<script type="text/javascript" src="../../../js/auto-complete.js?1720599204"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/\/vi";
    
</script>
<script type="text/javascript" src="../../../js/search.js?1720599204"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/1-/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/1-/1.1-api/" title="API" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/1-/1.1-api/">
           <b> 1.1 </b> API
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-/1.2-webhook/" title="Webhook" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/1-/1.2-webhook/">
           <b> 1.2 </b> Webhook
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-/1.3-layer/" title="Layer" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/1-/1.3-layer/">
           <b> 1.3 </b> Layer
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-/" title="Tạo ChatBot trên Telegram" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/2-/">
           <b> 2. </b> Tạo ChatBot trên Telegram
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-/" title="Các bước chuẩn bị" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/3-/">
           <b> 3. </b> Các bước chuẩn bị
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/3-/3.1-createvpc/" title="Tạo S3 Bucket" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/3-/3.1-createvpc/">
           <b> 3.1 </b> Tạo S3 Bucket
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/3-/3.2-createsubnet/" title="Tạo Lambda Function" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/3-/3.2-createsubnet/">
           <b> 3.2 </b> Tạo Lambda Function
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/3-/3.3-createigw/" title="Add Layer" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/3-/3.3-createigw/">
           <b> 3.3 </b> Add Layer
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-/" title="Lấy cookie từ shopee" class="dd-item 
        parent
        
        
        ">
      <a href="../../../vi/4-/">
           <b> 4. </b> Lấy cookie từ shopee
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/4-/4.1-createec2/" title="Lấy mật khẩu ứng dụng Gmail" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/4-/4.1-createec2/">
           <b> 4.1 </b> Lấy mật khẩu ứng dụng Gmail
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/4-/4.2-connectec2/" title="Trích xuất thông tin từ file json" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/4-/4.2-connectec2/">
           <b> 4.2 </b> Trích xuất thông tin từ file json
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/4-/4.3-natgateway/" title="Thêm code vào lambda function" class="dd-item 
        
        active
        
        ">
      <a href="../../../vi/4-/4.3-natgateway/">
           <b> 4.3 </b> Thêm code vào lambda function
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/4-/4.4.-createreachabilityanalyzer/" title="Add Trigger và permissions cho S3" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/4-/4.4.-createreachabilityanalyzer/">
           <b> 4.4 </b> Add Trigger và permissions cho S3
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-/" title="Tạo schema cho EventBridge" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/5-/">
           <b> 5. </b> Tạo schema cho EventBridge
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/6-/" title="Dọn dẹp tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="../../../vi/6-/">
           <b> 6. </b> Dọn dẹp tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj"><i class='fab fa-facebook'></i> AWS Study Group - Nhóm FB</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/4-/4.3-natgateway/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/4-/4.3-natgateway/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>26-11-2023</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
            <i> <a href="https://www.linkedin.com/in/huyvu15"  style="color:orange">Vũ Huy </a> <br> </i>
            <i> <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../../vi/'>Tạo ChatBot Quản lý chi tiêu qua Telegram</a> > <a href='../../../vi/4-/'>Lấy cookie từ shopee</a> > Thêm code vào lambda function
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Thêm code vào lambda function
            </h1>
          

        



	<h4 id="thêm-code-vào-lambda-function">Thêm code vào lambda function</h4>
<ol>
<li>
<p>Truy cập <strong>Lambda Function</strong></p>
<ul>
<li>Chọn <strong>Function</strong></li>
<li>Chọn <strong>Crawl_data</strong></li>
</ul>
</li>
</ol>
<p><img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/1.png?featherlight=false&width=90pc"></p>
<ol start="2">
<li>Kéo xuống và <strong>copy</strong> đoạn code sau vào <strong>lambda function</strong>, sửa thêm 1 số cái:
<ul>
<li>Với <strong>cookie, header, params, response</strong> để copy ở phần trước đó.(nhớ tag lại)</li>
<li>Thay đổi <strong>email cần gửi</strong> và <strong>email nhận.</strong></li>
</ul>
</li>
</ol>
<p><img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/2.png?featherlight=false&width=90pc"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3 
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> io <span style="color:#f92672">import</span> BytesIO
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> smtplib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">crawl</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&lt;cookie-api&gt;&#34;</span><span style="color:#75715e"># Lấy từ shopee từ bước </span>
</span></span><span style="display:flex;"><span>    products <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">301</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>        params[<span style="color:#e6db74">&#39;offset&#39;</span>] <span style="color:#f92672">=</span> i
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;https://shopee.vn/api/v4/order/get_all_order_and_checkout_list&#39;</span>, headers<span style="color:#f92672">=</span>headers, params<span style="color:#f92672">=</span>params, cookies<span style="color:#f92672">=</span>cookies)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>            data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;data&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;order_data&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;details_list&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> data <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(len(data)):
</span></span><span style="display:flex;"><span>                        order_info <span style="color:#f92672">=</span> data[j]
</span></span><span style="display:flex;"><span>                        main <span style="color:#f92672">=</span> order_info<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;info_card&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;order_list_cards&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;product_info&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;item_groups&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;items&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                        main1 <span style="color:#f92672">=</span> order_info<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;info_card&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;order_list_cards&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;shop_info&#39;</span>)
</span></span><span style="display:flex;"><span>                        main2 <span style="color:#f92672">=</span> order_info<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;shipping&#39;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;tracking_info&#39;</span>, {})
</span></span><span style="display:flex;"><span>                        product_id <span style="color:#f92672">=</span> main<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;item_id&#39;</span>)
</span></span><span style="display:flex;"><span>                        shop_id <span style="color:#f92672">=</span> main1<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;shop_id&#39;</span>)
</span></span><span style="display:flex;"><span>                        shop_name <span style="color:#f92672">=</span> main1<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;shop_name&#39;</span>)
</span></span><span style="display:flex;"><span>                        name <span style="color:#f92672">=</span> main<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>)
</span></span><span style="display:flex;"><span>                        price <span style="color:#f92672">=</span> main<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;item_price&#39;</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">100000</span> 
</span></span><span style="display:flex;"><span>                        amount <span style="color:#f92672">=</span> main<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;amount&#39;</span>)
</span></span><span style="display:flex;"><span>                        shop_name <span style="color:#f92672">=</span> main1<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;shop_name&#39;</span>)
</span></span><span style="display:flex;"><span>                        status <span style="color:#f92672">=</span> main2<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;description&#39;</span>, <span style="color:#e6db74">&#39;Đã hủy&#39;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> status <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Đã hủy&#39;</span>:
</span></span><span style="display:flex;"><span>                            status <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>  
</span></span><span style="display:flex;"><span>                            time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>    
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                            time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(main2<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;ctime&#39;</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                        products<span style="color:#f92672">.</span>append({
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;product_id&#39;</span>: product_id,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;shop_id&#39;</span>: shop_id,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;product_name&#39;</span>: name,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;shop_name&#39;</span>: shop_name,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;price&#39;</span>: price,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;amount&#39;</span>: amount,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;status&#39;</span>: status,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;time&#39;</span>: time
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> products        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_to_s3</span>(products):    
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(products)
</span></span><span style="display:flex;"><span>    csv_buffer <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO()
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>to_csv(csv_buffer, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8-sig&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    csv_buffer<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    csv_buffer_bytes <span style="color:#f92672">=</span> csv_buffer<span style="color:#f92672">.</span>getvalue()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    s3 <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;s3&#39;</span>)
</span></span><span style="display:flex;"><span>    bucket_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;do-lab&#39;</span>
</span></span><span style="display:flex;"><span>    file_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bill1.csv&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    s3<span style="color:#f92672">.</span>put_object(Body<span style="color:#f92672">=</span>csv_buffer_bytes, Bucket<span style="color:#f92672">=</span>bucket_name, Key<span style="color:#f92672">=</span>file_key, ContentType<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;text/csv; charset=utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;time&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(df[<span style="color:#e6db74">&#39;time&#39;</span>])
</span></span><span style="display:flex;"><span>    start_of_current_month <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Timestamp<span style="color:#f92672">.</span>now()<span style="color:#f92672">.</span>replace(day<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    start_of_previous_month <span style="color:#f92672">=</span> start_of_current_month <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>offsets<span style="color:#f92672">.</span>MonthBegin(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    data_previous_month <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;time&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_period(<span style="color:#e6db74">&#39;M&#39;</span>) <span style="color:#f92672">==</span> start_of_previous_month<span style="color:#f92672">.</span>to_period(<span style="color:#e6db74">&#39;M&#39;</span>)]
</span></span><span style="display:flex;"><span>    total_price_previous_month <span style="color:#f92672">=</span> data_previous_month[<span style="color:#e6db74">&#39;price&#39;</span>]<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> total_price_previous_month
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    products <span style="color:#f92672">=</span> crawl()
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> save_to_s3(products)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_email</span>(subject, msg, toEmail):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            server <span style="color:#f92672">=</span> smtplib<span style="color:#f92672">.</span>SMTP(<span style="color:#e6db74">&#39;smtp.gmail.com:587&#39;</span>)
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>ehlo()
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>starttls()
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>login(FROM_EMAIL_ADDRESS, PASSWORD)
</span></span><span style="display:flex;"><span>            message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Subject: </span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(subject, msg)
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>sendmail(FROM_EMAIL_ADDRESS, toEmail, message)
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>quit()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Success: Email sent!&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;Email failed to send.&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    FROM_EMAIL_ADDRESS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;email-gửi&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    TO_EMAIL_ADDRESSES <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;email-nhận&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;mật-khẩu-ứng-dụng-gmail&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    subject <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Notification of spending on shopping&#34;</span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">You are spend &#34;</span><span style="color:#f92672">+</span> str(result)<span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; for shopping activities at shopee&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    send_email(subject, msg, TO_EMAIL_ADDRESSES)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;statusCode&#39;</span>: <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;body&#39;</span>: json<span style="color:#f92672">.</span>dumps(<span style="color:#e6db74">&#39;Hello from Lambda!&#39;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div>
<div class="notices note" ><p><strong>Các phần cần sửa:</strong></p>
<p>bucket_name = &laquo;do_lab&raquo; // cái này để tùy ý bucket theo mong muốn.</p>
<p>&ldquo;&laquo;cookie-api&raquo;: Chỗ đã copy từ trang rút gọn api</p>
<p>FROM_EMAIL_ADDRESS = &ldquo;&laquo;email-gửi&raquo;&rdquo;</p>
<p>TO_EMAIL_ADDRESSES = &ldquo;&laquo;email-nhận&raquo;&rdquo;</p>
<p>PASSWORD = &ldquo;&laquo;mật-khẩu-ứng-dụng-gmail&raquo;&rdquo;</p>
</div>

<ol start="3">
<li>Nhấn <strong>Deploy</strong> để lưu code:</li>
</ol>
<p><img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/3.png?featherlight=false&width=90pc"></p>

<div class="notices note" ><p>Code trên đã điều chỉnh để đơn giản nhất có thể là chỉ dùng để thu thập dữ liệu và xử lý đơn giản để tính được số tiền chi tiêu trong tháng trước đó và lưu file dữ liệu vào S3.</p>
<p>Có thể phát triển thêm theo hướng là dùng thư viện <strong>pandas</strong> để vẽ các biểu đồ, doanh thu các ngày, phân tích đánh giá như sử dụng BI tool và gửi hết tất cả những phân tích đó qua email.</p>
</div>


<div class="notices note" ><p>Khi nhấn test code sẽ k<strong>hông chạy được</strong> và bị <strong>time out</strong> ngay lập tức. Lý do là do <strong>lambda function</strong> mặc định được cấu hình <strong>time out là 3s</strong>. Một funtion có thời gian timeout tối đa là 15p. Đây cùng là một trong những lý do lambda không được sử dụng để train các mô hình AI do thời gian time out tương đối thấp. Code trên thực hiện sẽ mất tầm <strong>1p</strong>. Sau đây ta sẽ đi cấu hình thời gian <strong>time out cho Lambda</strong>.</p>
</div>

<ol start="4">
<li>Cấu hình <strong>time out</strong>
<ul>
<li>Tại giao diện function chọn <strong>Configuration</strong>.</li>
<li>Chọn <strong>General configuration</strong>.</li>
<li>Chọn <strong>Edit</strong>.</li>
</ul>
</li>
</ol>
<p><img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/4.png?featherlight=false&width=90pc"></p>
<ol start="5">
<li>Nhập thông số:
<ul>
<li>Description <strong><code>Increate amout time out</code></strong>.</li>
<li>Memory <strong><code>512</code></strong>.</li>
<li>Time out <strong><code>1</code></strong>.</li>
<li>Nhấn <strong>Save</strong>.
<img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/5.png?featherlight=false&width=90pc">
<img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/6.png?featherlight=false&width=90pc"></li>
</ul>
</li>
</ol>

<div class="notices note" ><p>Hiện tại bạn có thể nhấn luôn phím test để test thử đoạn code. Nếu có mail gửi về là thành công được 80% rồi. Tiếp theo chúng ta sẽ đi cài lịch cho Lambda Function chạy vào đầu tháng. Và kết quả thu được sẽ là số tiền đã chi cho tháng trước.</p>
</div>

<p><img alt="Create VPC" src="../../../images/4-CreateEc2Server/4.3-addcode/7.png?featherlight=false&width=90pc"></p>

<div class="notices tip" ><p>Nếu có lỗi là do chỗ lấy thông tin từ web bị thay đổi. Hoặc là do cookies hết hạn và cần phải lặp lại các bước để lấy lại từ shopee.</p>
</div>






<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../../../vi/4-/4.2-connectec2/" title="Trích xuất thông tin từ file json"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../../vi/4-/4.4.-createreachabilityanalyzer/" title="Add Trigger và permissions cho S3" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../../js/clipboard.min.js?1720599204"></script>
    <script src="../../../js/perfect-scrollbar.min.js?1720599204"></script>
    <script src="../../../js/perfect-scrollbar.jquery.min.js?1720599204"></script>
    <script src="../../../js/jquery.sticky.js?1720599204"></script>
    <script src="../../../js/featherlight.min.js?1720599204"></script>
    <script src="../../../js/highlight.pack.js?1720599204"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../../../js/modernizr.custom-3.6.0.js?1720599204"></script>
    <script src="../../../js/learn.js?1720599204"></script>
    <script src="../../../js/hugo-learn.js?1720599204"></script>

    <link href="../../../mermaid/mermaid.css?1720599204" rel="stylesheet" />
    <script src="../../../mermaid/mermaid.js?1720599204"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
